#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

LIBMAXMINDDB_VERSION=1.4.2
GEOLITE2_CITY_FILENAME="GeoLite2-City.mmdb"
GEOLITE2_CITY_TARBALL_FILENAME="GeoLite2-City.mmdb.tar.gz"
GEOLITE2_COUNTRY_FILENAME="GeoLite2-Country.mmdb"
GEOLITE2_COUNTRY_TARBALL_FILENAME="GeoLite2-Country.mmdb.tar.gz"
GEOLITE2_VERSION_FILE="version"

BUILD_DIST_DIR="$BUILD_DIR/.geoip"
BUILD_DIST_SHARE_DIR="$BUILD_DIST_DIR/share"
GEOIP_DB_PUBLIC_URI=`cat "$ENV_DIR/GEOIP_DB_PUBLIC_URI"`

echo "-----> Downloading DB from $GEOIP_DB_PUBLIC_URI"

mkdir -p "$BUILD_DIST_DIR"
mkdir -p "$BUILD_DIST_SHARE_DIR"

wget "$GEOIP_DB_PUBLIC_URI/$GEOLITE2_CITY_TARBALL_FILENAME" -O "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME"
wget "$GEOIP_DB_PUBLIC_URI/$GEOLITE2_COUNTRY_TARBALL_FILENAME" -O "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME"
wget "$GEOIP_DB_PUBLIC_URI/$GEOLITE2_VERSION_FILE" -O "$BUILD_DIST_SHARE_DIR/$GEOLITE2_VERSION_FILE"

echo "-----> Extracting DB"
tar -tzf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME" | grep "$GEOLITE2_CITY_FILENAME" | xargs -I {} tar -xzvf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME" {}
tar -tzf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME" | grep "$GEOLITE2_CITY_FILENAME" | xargs -I {} mv {} "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_FILENAME"
tar -tzf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME" | grep "$GEOLITE2_COUNTRY_FILENAME" | xargs -I {} tar -xzvf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME" {}
tar -tzf "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME" | grep "$GEOLITE2_COUNTRY_FILENAME" | xargs -I {} mv {} "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_FILENAME"

echo "-----> Cleanup"
rm -f "$BUILD_DIST_SHARE_DIR/$GEOLITE2_CITY_TARBALL_FILENAME"
rm -f "$BUILD_DIST_SHARE_DIR/$GEOLITE2_COUNTRY_TARBALL_FILENAME"
